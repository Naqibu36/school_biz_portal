<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø³Ú©ÙˆÙ„ + Ø¨Ø²Ù†Ø³ POS Ù¾ÙˆØ±Ù¹Ù„</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --green:#2e7d32; --green2:#388e3c; --green3:#1b5e20;
    --blue:#2563eb; --blue2:#1d4ed8; --violet:#7c3aed;
    --bg:#f6f8fc; --card:#ffffff; --text:#0f172a; --muted:#475569;
    --accent:#22c55e; --danger:#ef4444; --amber:#f59e0b; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tajawal,Segoe UI,Arial,Tahoma,sans-serif;background:var(--bg);color:var(--text)}
  a{color:#2563eb;text-decoration:none}
  header{background:linear-gradient(135deg,var(--blue),var(--violet));color:#fff;text-align:center;padding:28px 16px}
  header h1{margin:0 0 6px;font-size:28px}
  header p{margin:0;opacity:.95}
  .container{max-width:1200px;margin:0 auto;padding:18px 14px}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 0}
  .tab-btn{background:#e0e7ff;color:#1e3a8a;border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer;transition:.2s}
  .tab-btn.active,.tab-btn:hover{background:#c7d2fe}
  .panel{display:none}
  .panel.active{display:block}
  .card{background:var(--card);border-radius:18px;box-shadow:0 8px 22px rgba(0,0,0,.08);padding:16px;margin:14px 0;border:1px solid var(--border)}
  h2{margin:0 0 10px;color:var(--green)}
  h3{margin:8px 0;color:var(--blue)}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-4{grid-template-columns:repeat(4,1fr)}
  }
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;margin:4px 2px}
  .btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{background:var(--blue2)}
  .btn-green{background:var(--green);color:#fff}.btn-green:hover{background:var(--green3)}
  .btn-ghost{background:#eef2ff;color:#1e3a8a}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-amber{background:var(--amber);color:#111}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,textarea{padding:9px;border-radius:10px;border:1px solid #d1d5db;font-size:15px;width:100%}
  label{font-weight:700;color:var(--muted);font-size:14px;margin:4px 0}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
  th{background:var(--green);color:#fff}
  tr:nth-child(even){background:#fafafa}
  .teacher-card{border:1px dashed #d1d5db;border-radius:14px;padding:12px;text-align:center}
  .teacher-card img{width:96px;height:96px;border-radius:50%;object-fit:cover;border:3px solid #eee;background:#fff}
  .kpi{background:#0b1220;color:#dbeafe;border-radius:12px;padding:12px;text-align:center}
  .kpi b{display:block;font-size:18px;margin-top:4px;color:#fff}
  footer{margin-top:18px;background:#0f172a;color:#cbd5e1;text-align:center;padding:16px}
  .badge{display:inline-block;background:#e2e8f0;border-radius:999px;padding:4px 10px;margin:0 4px}
  .subtabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .subtabs .chip{padding:8px 12px;border-radius:999px;background:#e2e8f0;cursor:pointer;font-weight:700}
  .subtabs .chip.active{background:#dbeafe;color:#1e3a8a;border:1px solid #bfdbfe}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#ecfccb;color:#3f6212;font-size:12px;border:1px solid #bbf7d0}
  .thumb{width:72px;height:72px;border-radius:10px;object-fit:cover;border:1px solid #e5e7eb;background:#fff}
</style>
</head>
<body>
<header>
  <h1>ğŸ“š Ø³Ú©ÙˆÙ„ + ğŸ’¼ Ø¨Ø²Ù†Ø³ POS Ù¾ÙˆØ±Ù¹Ù„</h1>
  <p class="muted">Ø§ÛŒÚ© ÛÛŒ ØµÙØ­Û: Ø§Ø³Ø§ØªØ°Û/Ù¹Ø§Ø¦Ù… Ù¹ÛŒØ¨Ù„ + POS + Ú©Ø³Ù¹Ù…Ø± Ù¾ÙˆØ±Ù¹Ù„ â€” Ø³Ø¨ Ú©Ú†Ú¾ Ù„ÙˆÚ©Ù„ Ø§Ø³Ù¹ÙˆØ±ÛŒØ¬ Ù¾Ø± (Ø¢Ù†/Ø¢Ù Ù„Ø§Ø¦Ù†)</p>
  <div class="tabs">
    <button class="tab-btn active" data-tab="school">Ø³Ú©ÙˆÙ„ Ù¾ÛŒÙ†Ù„</button>
    <button class="tab-btn" data-tab="business">Ø¨Ø²Ù†Ø³ / POS</button>
  </div>
</header>

<div class="container">

  <!-- KPIs -->
  <div class="grid grid-4">
    <div class="kpi">Ø§Ø³Ø§ØªØ°Û<b id="kpiTeachers">0</b></div>
    <div class="kpi">Ø¢Ø¦Ù¹Ù…Ø² (Ø§Ø³Ù¹Ø§Ú©)<b id="kpiItems">0</b></div>
    <div class="kpi">Ú©Ù„ Ø³ÛŒÙ„Ø² (Ø¢Ø¬)<b id="kpiSalesToday">0</b></div>
    <div class="kpi">Ù…Ù†Ø§ÙØ¹ (Ø¢Ø¬)<b id="kpiProfitToday">0</b></div>
  </div>

  <!-- ================= SCHOOL PANEL ================= -->
  <section id="school" class="panel active">
    <!-- Teachers -->
    <div class="card">
      <h2>ğŸ‘©â€ğŸ« Ø§Ø³Ø§ØªØ°Û (8)</h2>
      <div class="grid grid-4" id="teachersGrid"></div>
      <div class="row" style="justify-content:center;margin-top:8px">
        <button class="btn btn-green" onclick="saveTeachers()">Ø§Ø³Ø§ØªØ°Û Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
        <button class="btn btn-ghost" onclick="resetTeachers()">ÚˆÛŒÙØ§Ù„Ù¹ Ø¨Ø­Ø§Ù„</button>
      </div>
    </div>

    <!-- Timetable -->
    <div class="card">
      <h2>ğŸ“… Ù¹Ø§Ø¦Ù… Ù¹ÛŒØ¨Ù„ (Ù¾ÛŒØ± ØªØ§ ÛÙØªÛ â€” 8 Ù¾ÛŒØ±ÛŒÚˆØ²)</h2>
      <div class="muted" style="margin-bottom:6px">ÛØ± Ø®Ø§Ù†Û’ Ù…ÛŒÚº Ù…Ø¶Ù…ÙˆÙ† Ú©Ø§ Ù†Ø§Ù… Ù„Ú©Ú¾ÛŒÚºÛ” Ø³Ø¨ Ú©Ú†Ú¾ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ø­ÙÙˆØ¸ ÛÙˆØªØ§ ÛÛ’Û”</div>
      <div id="ttWrap" style="overflow:auto">
        <table id="ttTable" aria-label="School Timetable">
          <thead>
            <tr>
              <th>Ø¯Ù†</th>
              <th>Ù¾ÛŒØ±ÛŒÚˆ 1</th><th>Ù¾ÛŒØ±ÛŒÚˆ 2</th><th>Ù¾ÛŒØ±ÛŒÚˆ 3</th><th>Ù¾ÛŒØ±ÛŒÚˆ 4</th>
              <th>Ù¾ÛŒØ±ÛŒÚˆ 5</th><th>Ù¾ÛŒØ±ÛŒÚˆ 6</th><th>Ù¾ÛŒØ±ÛŒÚˆ 7</th><th>Ù¾ÛŒØ±ÛŒÚˆ 8</th>
            </tr>
          </thead>
          <tbody id="ttBody"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:center;margin-top:8px">
        <button class="btn btn-amber" onclick="downloadTTasPDF()">PDF ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ</button>
        <button class="btn btn-primary" onclick="shareTTWhatsApp()">WhatsApp Ø´ÛŒØ¦Ø±</button>
        <button class="btn btn-ghost" onclick="resetTimetable()">ÚˆÛŒÙØ§Ù„Ù¹ Ø¨Ø­Ø§Ù„</button>
      </div>
    </div>
  </section>

  <!-- ================= BUSINESS PANEL ================= -->
  <section id="business" class="panel">

    <!-- Sub tabs: Admin vs Customer -->
    <div class="subtabs">
      <span class="chip active" data-subtab="adminTab">Ø§ÛŒÚˆÙ…Ù†</span>
      <span class="chip" data-subtab="customerTab">Ú©Ø³Ù¹Ù…Ø±</span>
    </div>

    <!-- ========== ADMIN AUTH & POS ========== -->
    <div id="adminTab" class="subpanel">
      <!-- Admin Login -->
      <div class="card">
        <h2>ğŸ” Ø§ÛŒÚˆÙ…Ù† Ù„Ø§Ú¯ Ø§ÙÙ†</h2>
        <div class="grid grid-3">
          <div>
            <label>Ø§ÛŒ Ù…ÛŒÙ„ (Ø§ÛŒÚˆÙ…Ù†)</label>
            <input id="adminEmail" placeholder="Ø§ÛŒ Ù…ÛŒÙ„" value="naqibullahshah58@gmail.com">
          </div>
          <div>
            <label>ÙÙˆÙ†/ÙˆØ§Ù¹Ø³ Ø§ÛŒÙ¾</label>
            <input id="adminPhone" placeholder="0341xxxxxxx" value="03419208226">
          </div>
          <div>
            <label>Ù¾Ø§Ø³ ÙˆØ±Úˆ</label>
            <input id="adminPass" type="password" placeholder="Ù¾Ø§Ø³ ÙˆØ±Úˆ">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-green" onclick="setAdmin()">Set Admin (Ù¾ÛÙ„ÛŒ Ø¨Ø§Ø±)</button>
          <button class="btn btn-primary" onclick="loginAdmin()">Login</button>
          <span id="loginMsg" class="muted"></span>
        </div>
      </div>

      <!-- POS Area (only after admin login) -->
      <div id="posArea" style="display:none">
        <!-- Customers Admin -->
        <div class="card">
          <h2>ğŸ‘¥ Ú©Ø³Ù¹Ù…Ø±Ø² (Ø§ÛŒÚˆÙ…Ù†)</h2>
          <div class="grid grid-4">
            <div><label>Ù†Ø§Ù…</label><input id="admCName"></div>
            <div><label>Ø§ÛŒ Ù…ÛŒÙ„</label><input id="admCEmail"></div>
            <div><label>ÙÙˆÙ†</label><input id="admCPhone"></div>
            <div class="row"><button class="btn btn-green" onclick="adminAddCustomer()">Ø´Ø§Ù…Ù„</button></div>
          </div>
          <div style="margin-top:8px;overflow:auto">
            <table>
              <thead><tr><th>#</th><th>Ù†Ø§Ù…</th><th>Ø§ÛŒ Ù…ÛŒÙ„</th><th>ÙÙˆÙ†</th><th>Ø¹Ù…Ù„</th></tr></thead>
              <tbody id="adminCustBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Inventory -->
        <div class="card">
          <h2>ğŸ“¦ Inventory / Ø§Ø³Ù¹Ø§Ú©</h2>
          <div class="grid grid-4">
            <div><label>Ù†Ø§Ù…</label><input id="pName"></div>
            <div><label>Ø¨Ø§Ø±Ú©ÙˆÚˆ</label><input id="pBarcode" placeholder="1234567890123"></div>
            <div><label>Ù„Ø§Ú¯Øª Ù‚ÛŒÙ…Øª</label><input id="pCost" type="number" step="0.01"></div>
            <div><label>Ø³ÛŒÙ„ Ù‚ÛŒÙ…Øª</label><input id="pPrice" type="number" step="0.01"></div>
            <div><label>Quantity</label><input id="pQty" type="number"></div>
            <div class="row"><button class="btn btn-green" onclick="addItem()">Ø¢Ø¦Ù¹Ù… Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button></div>
          </div>
          <div style="margin-top:8px;overflow:auto">
            <table id="invTable">
              <thead>
                <tr><th>#</th><th>Ù†Ø§Ù…</th><th>Ø¨Ø§Ø±Ú©ÙˆÚˆ</th><th>Ù„Ø§Ú¯Øª</th><th>Ù‚ÛŒÙ…Øª</th><th>Qty</th><th>Ø­Ø°Ù</th></tr>
              </thead>
              <tbody id="invBody"></tbody>
            </table>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-ghost" onclick="exportJSON('inventory')">JSON Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹</button>
            <button class="btn btn-ghost" onclick="exportCSV('inventory')">CSV Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹</button>
            <label class="badge">Import JSON: <input type="file" accept="application/json" onchange="importJSON(event,'inventory')"></label>
          </div>
        </div>

        <!-- Sales -->
        <div class="card">
          <h2>ğŸ§¾ Sales / Ú©Ø§Ø±Ù¹ & Ø§Ù†ÙˆØ§Ø¦Ø³</h2>
          <div class="grid grid-4">
            <div><label>Ø¨Ø§Ø±Ú©ÙˆÚˆ / Ù†Ø§Ù…</label><input id="saleSearch" placeholder="Scan ÛŒØ§ Ù†Ø§Ù… Ù„Ú©Ú¾ÛŒÚº"></div>
            <div><label>Qty</label><input id="saleQty" type="number" value="1"></div>
            <div class="row"><button class="btn btn-green" onclick="addToCart()">Ú©Ø§Ø±Ù¹ Ù…ÛŒÚº Ø´Ø§Ù…Ù„</button></div>
          </div>
          <div style="margin-top:8px;overflow:auto">
            <table>
              <thead><tr><th>#</th><th>Ù†Ø§Ù…</th><th>Ø¨Ø§Ø±Ú©ÙˆÚˆ</th><th>Ù‚ÛŒÙ…Øª</th><th>Qty</th><th>Ú©Ù„</th><th>Ø­Ø°Ù</th></tr></thead>
              <tbody id="cartBody"></tbody>
            </table>
          </div>
          <div class="grid grid-4" style="margin-top:8px">
            <div><label>ÚˆØ³Ú©Ø§Ø¤Ù†Ù¹ (%)</label><input id="discPct" type="number" value="0"></div>
            <div><label>Ù¹ÛŒÚ©Ø³ (%)</label><input id="taxPct" type="number" value="0"></div>
            <div class="kpi">Ø¨Ù„ Ú©ÛŒ Ø±Ù‚Ù…<b id="billTotal">0</b></div>
            <div class="kpi">Ù…Ù†Ø§ÙØ¹ (Ø§Ø³ Ø¨ÛŒÙ„)<b id="billProfit">0</b></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-primary" onclick="finalizeSale()">Finalize / Save</button>
            <button class="btn btn-amber" onclick="printInvoice()">Ù¾Ø±Ù†Ù¹/PDF Ø§Ù†ÙˆØ§Ø¦Ø³</button>
            <button class="btn btn-ghost" onclick="shareInvoiceWA()">WhatsApp Ø´ÛŒØ¦Ø±</button>
            <button class="btn btn-danger" onclick="clearCart()">Ú©Ø§Ø±Ù¹ ØµØ§Ù</button>
          </div>
          <div id="invoiceArea" class="card" style="display:none;margin-top:10px">
            <h3>Ø±Ø³ÛŒØ¯ / Invoice</h3>
            <div id="invoiceContent"></div>
          </div>
        </div>

        <!-- Reports -->
        <div class="card">
          <h2>ğŸ“ˆ Ø±Ù¾ÙˆØ±Ù¹Ø³</h2>
          <div class="grid grid-3">
            <div><label>ØªØ§Ø±ÛŒØ® Ø³Û’</label><input id="repFrom" type="date"></div>
            <div><label>ØªØ§Ø±ÛŒØ® ØªÚ©</label><input id="repTo" type="date"></div>
            <div class="row"><button class="btn btn-green" onclick="buildReport()">Ø±Ù¾ÙˆØ±Ù¹ Ø¨Ù†Ø§Ø¦ÛŒÚº</button></div>
          </div>
          <div class="grid grid-3" style="margin-top:8px">
            <div class="kpi">Total Sales<b id="repSales">0</b></div>
            <div class="kpi">Total Profit<b id="repProfit">0</b></div>
            <div class="kpi">Bills Count<b id="repBills">0</b></div>
          </div>
          <div class="card" style="margin-top:8px">
            <h3>Hot Items</h3>
            <ul id="hotItems"></ul>
            <h3 style="margin-top:8px">Dead Items</h3>
            <ul id="deadItems"></ul>
          </div>
          <div class="row" style="margin-top:6px">
            <button class="btn btn-amber" onclick="exportJSON('sales')">Sales JSON</button>
            <button class="btn btn-ghost" onclick="exportCSV('sales')">Sales CSV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== CUSTOMER AUTH & SELF-SERVICE ========== -->
    <div id="customerTab" class="subpanel" style="display:none">
      <!-- Auth -->
      <div class="card">
        <h2>ğŸ‘¤ Ú©Ø³Ù¹Ù…Ø± Ù¾ÙˆØ±Ù¹Ù„</h2>
        <div class="grid grid-3">
          <div>
            <label>Ù†Ø§Ù…</label>
            <input id="cName" placeholder="Ø¢Ù¾ Ú©Ø§ Ù†Ø§Ù…">
          </div>
          <div>
            <label>Ø§ÛŒ Ù…ÛŒÙ„</label>
            <input id="cEmail" placeholder="email@example.com">
          </div>
          <div>
            <label>ÙÙˆÙ†</label>
            <input id="cPhone" placeholder="03xxxxxxxxx">
          </div>
          <div>
            <label>Ù¾Ø§Ø³ ÙˆØ±Úˆ</label>
            <input id="cPass" type="password" placeholder="Ù¾Ø§Ø³ ÙˆØ±Úˆ">
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="btn btn-green" onclick="custRegister()">Register</button>
            <button class="btn btn-primary" onclick="custLogin()">Login</button>
            <button class="btn btn-ghost" onclick="custForgot()">Forgot Password</button>
          </div>
          <div class="row"><span id="cAuthMsg" class="muted"></span></div>
        </div>
      </div>

      <!-- Customer Area -->
      <div id="custArea" style="display:none">
        <div class="card">
          <h2>ğŸ§¾ Ù…ÛŒØ±ÛŒ Ø±Ø³ÛŒØ¯ÛŒÚº / Ø§Ù¾Ù„ÙˆÚˆ</h2>
          <div class="row">
            <input id="rcNote" placeholder="ØªÙØµÛŒÙ„/Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
            <input id="rcFile" type="file" accept="image/*,application/pdf" multiple>
            <button class="btn btn-green" onclick="custUpload()">Ø§Ù¾Ù„ÙˆÚˆ</button>
          </div>
          <div class="muted" style="margin-top:6px">
            ØªØµÙˆÛŒØ±/PDF Ø§Ù¾Ù„ÙˆÚˆ ÛÙˆØªÛ’ ÛÛŒ Ù†ÛŒÚ†Û’ Ù†Ø¸Ø± Ø¢Ø¦Û’ Ú¯ÛŒÛ” Ø¢Ù¾ Ø§Ù¾Ù†ÛŒ ÛØ± Ø§Ù†Ù¹Ø±ÛŒ **Ø§ÛŒÚˆÛŒÙ¹/Ø­Ø°Ù** Ú©Ø± Ø³Ú©ØªÛ’ ÛÛŒÚºÛ”
          </div>
          <div id="rcList" class="grid grid-4" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

  </section>
</div>

<footer>
  Â© 2025 â€” Ø³Ú©ÙˆÙ„ + Ø¨Ø²Ù†Ø³ POS (Ù„ÙˆÚ©Ù„ Ø§Ø³Ù¹ÙˆØ±ÛŒØ¬). Ø±Ø§Ø¨Ø·Û: <a href="https://wa.me/923419208226" target="_blank">0341-9208226</a> â€” <a href="mailto:naqibullahshah58@gmail.com">naqibullahshah58@gmail.com</a>
</footer>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ================== UTIL & STORAGE ================== */
const LS = {
  get:k=>{ try{return JSON.parse(localStorage.getItem(k)||'null')}catch{ return null }},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:k=>localStorage.removeItem(k)
};
const fmt = n => Number(n||0).toFixed(2);
const todayISO = ()=> new Date().toISOString().slice(0,10);

/* Keys */
const K = {
  teachers:'sch_teachers',
  timetable:'sch_timetable',
  admin:'pos_admin',
  inv:'pos_inventory',
  sales:'pos_sales',
  cart:'pos_cart',
  customers:'pos_customers',
  session:'pos_session'  // {role:'admin'|'customer', id/email}
};

/* ================== TOP TABS ================== */
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    b.classList.add('active');
    document.getElementById(b.dataset.tab).classList.add('active');
  };
});

/* ================== SUB TABS (Business) ================== */
document.querySelectorAll('.subtabs .chip').forEach(ch=>{
  ch.onclick=()=>{
    document.querySelectorAll('.subtabs .chip').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.subpanel').forEach(p=>p.style.display='none');
    ch.classList.add('active');
    document.getElementById(ch.dataset.subtab).style.display='block';
  };
});

/* ================== SCHOOL: TEACHERS ================== */
const defaultTeachers = ()=> Array.from({length:8},(_,i)=>({ name:`Ø§Ø³ØªØ§Ø¯ ${i+1}`, img:null }));

function renderTeachers(){
  const t = LS.get(K.teachers) || defaultTeachers();
  const grid = document.getElementById('teachersGrid');
  grid.innerHTML='';
  t.forEach((tc,idx)=>{
    const card = document.createElement('div');
    card.className='teacher-card';
    card.innerHTML=`
      <img id="timg${idx}" src="${tc.img || 'https://cdn-icons-png.flaticon.com/512/201/201818.png'}" alt="teacher">
      <input id="tname${idx}" value="${tc.name}">
      <input type="file" accept="image/*" onchange="onTeacherImg(${idx},event)">
    `;
    grid.appendChild(card);
  });
  document.getElementById('kpiTeachers').textContent = t.length;
}
function onTeacherImg(i,ev){
  const file = ev.target.files[0]; if(!file) return;
  const rd = new FileReader();
  rd.onload = ()=> { document.getElementById('timg'+i).src = rd.result; };
  rd.readAsDataURL(file);
}
function saveTeachers(){
  const t = [];
  for(let i=0;i<8;i++){
    const name = document.getElementById('tname'+i).value.trim() || ('Ø§Ø³ØªØ§Ø¯ '+(i+1));
    const img = document.getElementById('timg'+i).src || null;
    t.push({name,img});
  }
  LS.set(K.teachers,t);
  alert('Ø§Ø³Ø§ØªØ°Û Ù…Ø­ÙÙˆØ¸ ÛÙˆÚ¯Ø¦Û’ âœ…');
}
function resetTeachers(){ LS.set(K.teachers, defaultTeachers()); renderTeachers(); }

/* ================== SCHOOL: TIMETABLE ================== */
const days = ['Ù¾ÛŒØ±','Ù…Ù†Ú¯Ù„','Ø¨Ø¯Ú¾','Ø¬Ù…Ø¹Ø±Ø§Øª','Ø¬Ù…Ø¹Û','ÛÙØªÛ']; // Ø§ØªÙˆØ§Ø± Ø´Ø§Ù…Ù„ Ù†ÛÛŒÚº
function defaultTT(){
  const obj={}; days.forEach(d=>{ obj[d]=Array.from({length:8},(_,i)=>`Ù…Ø¶Ù…ÙˆÙ† ${i+1}`); });
  return obj;
}
function renderTimetable(){
  const tt = LS.get(K.timetable) || defaultTT();
  const tb = document.getElementById('ttBody');
  tb.innerHTML='';
  days.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><b>${d}</b></td>` + tt[d].map((sub,i)=>`<td contenteditable="true" data-day="${d}" data-idx="${i}">${sub}</td>`).join('');
    tb.appendChild(tr);
  });
  tb.querySelectorAll('td[contenteditable]').forEach(td=>{
    td.addEventListener('input',()=>{
      const d=td.dataset.day, i=td.dataset.idx;
      const obj = LS.get(K.timetable) || defaultTT();
      obj[d][i] = td.textContent.trim();
      LS.set(K.timetable,obj);
    });
  });
}
async function downloadTTasPDF(){
  const { jsPDF } = window.jspdf;
  const node = document.getElementById('ttTable');
  const canvas = await html2canvas(node,{scale:2});
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p','mm','a4');
  const pageW=pdf.internal.pageSize.getWidth();
  const ratio = canvas.width/canvas.height;
  const w=pageW-20, h=w/ratio;
  pdf.addImage(img,'PNG',10,10,w,h);
  pdf.save('timetable.pdf');
}
function shareTTWhatsApp(){
  const msg = 'ğŸ“… ÛÙ…Ø§Ø±Ø§ Ø§Ø³Ú©ÙˆÙ„ Ù¹Ø§Ø¦Ù… Ù¹ÛŒØ¨Ù„ Ø¯ÛŒÚ©Ú¾ÛŒÚº';
  const url = "https://"+location.host+location.pathname;
  window.open('https://wa.me/?text='+encodeURIComponent(msg+' '+url),'_blank');
}
function resetTimetable(){ LS.set(K.timetable, defaultTT()); renderTimetable(); }

/* ================== ADMIN AUTH ================== */
function setAdmin(){
  const email = adminEmail.value.trim();
  const phone = adminPhone.value.trim();
  const pass = adminPass.value;
  if(!email || !pass){ return alert('Ø§ÛŒ Ù…ÛŒÙ„ Ø§ÙˆØ± Ù¾Ø§Ø³ ÙˆØ±Úˆ Ø¯ÛŒÚº'); }
  LS.set(K.admin,{email,phone,pass});
  loginMsg.textContent='Ø§ÛŒÚˆÙ…Ù† Ø³ÛŒÙ¹ ÛÙˆÚ¯ÛŒØ§ âœ…';
}
function loginAdmin(){
  const adm = LS.get(K.admin);
  if(!adm){ return alert('Ù¾ÛÙ„Û’ Set Admin Ú©Ø±ÛŒÚº'); }
  const email = adminEmail.value.trim();
  const pass = adminPass.value;
  if(email===adm.email && pass===adm.pass){
    LS.set(K.session,{role:'admin', email});
    posArea.style.display='block';
    loginMsg.textContent='Ù„Ø§Ú¯ Ø§Ù† Ú©Ø§Ù…ÛŒØ§Ø¨ âœ…';
    refreshAdminScreens();
  } else {
    loginMsg.textContent='ØºÙ„Ø· ØªÙØµÛŒÙ„ âŒ';
  }
}

/* ================== CUSTOMERS (ADMIN SIDE) ================== */
function getCustomers(){ return LS.get(K.customers) || []; }
function setCustomers(arr){ LS.set(K.customers,arr); renderAdminCustomers(); }
function adminAddCustomer(){
  const n=admCName.value.trim(), e=admCEmail.value.trim(), p=admCPhone.value.trim();
  if(!n || !e) return alert('Ù†Ø§Ù… Ø§ÙˆØ± Ø§ÛŒ Ù…ÛŒÙ„ Ø¶Ø±ÙˆØ±ÛŒ');
  const arr=getCustomers();
  if(arr.find(x=>x.email===e)) return alert('ÛŒÛ Ø§ÛŒ Ù…ÛŒÙ„ Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’');
  arr.push({id:Date.now(), name:n, email:e, phone:p, pass:''});
  setCustomers(arr);
  admCName.value=admCEmail.value=admCPhone.value='';
}
function adminEditCustomer(id){
  const arr=getCustomers();
  const ix = arr.findIndex(x=>x.id===id); if(ix<0) return;
  const n = prompt('Ù†Ø§Ù…', arr[ix].name) ?? arr[ix].name;
  const p = prompt('ÙÙˆÙ†', arr[ix].phone||'') ?? arr[ix].phone;
  arr[ix].name=n; arr[ix].phone=p;
  setCustomers(arr);
}
function adminResetCustPass(id){
  const arr=getCustomers();
  const ix = arr.findIndex(x=>x.id===id); if(ix<0) return;
  const np = prompt('Ù†ÛŒØ§ Ù¾Ø§Ø³ ÙˆØ±Úˆ') || '';
  if(!np) return;
  arr[ix].pass = np;
  setCustomers(arr);
  alert('Ú©Ø³Ù¹Ù…Ø± Ù¾Ø§Ø³ ÙˆØ±Úˆ Ø±ÛŒ Ø³ÛŒÙ¹ ÛÙˆÚ¯ÛŒØ§ âœ…');
}
function adminDelCustomer(id){
  if(!confirm('Ø§Ø³ Ú©Ø³Ù¹Ù…Ø± Ú©Ùˆ Ø­Ø°Ù Ú©Ø±ÛŒÚºØŸ')) return;
  const arr=getCustomers().filter(x=>x.id!==id);
  setCustomers(arr);
}
function renderAdminCustomers(){
  const arr=getCustomers();
  adminCustBody.innerHTML = arr.map((c,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${c.name}</td>
      <td>${c.email}</td>
      <td>${c.phone||'-'}</td>
      <td>
        <button class="btn btn-ghost" onclick="adminEditCustomer(${c.id})">Ø§ÛŒÚˆÛŒÙ¹</button>
        <button class="btn btn-amber" onclick="adminResetCustPass(${c.id})">Ù¾Ø§Ø³ Ø±ÛŒ Ø³ÛŒÙ¹</button>
        <button class="btn btn-danger" onclick="adminDelCustomer(${c.id})">Ø­Ø°Ù</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="5">Ú©ÙˆØ¦ÛŒ Ú©Ø³Ù¹Ù…Ø± Ù†ÛÛŒÚº</td></tr>';
}

/* ================== CUSTOMER AUTH (SELF) ================== */
function custRegister(){
  const n=cName.value.trim(), e=cEmail.value.trim(), p=cPhone.value.trim(), pw=cPass.value;
  if(!n || !e || !pw) return cAuthMsg.textContent='Ù†Ø§Ù…/Ø§ÛŒ Ù…ÛŒÙ„/Ù¾Ø§Ø³ ÙˆØ±Úˆ Ø¯ÛŒÚº';
  const arr=getCustomers();
  if(arr.find(x=>x.email===e)) return cAuthMsg.textContent='Ø§ÛŒ Ù…ÛŒÙ„ Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’';
  const obj={id:Date.now(), name:n, email:e, phone:p, pass:pw};
  arr.push(obj); setCustomers(arr);
  LS.set(K.session,{role:'customer', id:obj.id, email:obj.email});
  cAuthMsg.textContent='Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù† Ú©Ø§Ù…ÛŒØ§Ø¨ âœ…';
  openCustomerArea();
}
function custLogin(){
  const e=cEmail.value.trim(), pw=cPass.value;
  const arr=getCustomers();
  const u = arr.find(x=>x.email===e && x.pass===pw);
  if(!u){ cAuthMsg.textContent='ØºÙ„Ø· Ø§ÛŒ Ù…ÛŒÙ„ ÛŒØ§ Ù¾Ø§Ø³ ÙˆØ±Úˆ'; return; }
  LS.set(K.session,{role:'customer', id:u.id, email:u.email});
  cAuthMsg.textContent='Ù„Ø§Ú¯ Ø§Ù† Ú©Ø§Ù…ÛŒØ§Ø¨ âœ…';
  openCustomerArea();
}
function custForgot(){
  const e=cEmail.value.trim(), p=cPhone.value.trim();
  const arr=getCustomers();
  const u = arr.find(x=>x.email===e && (p? x.phone===p : true));
  if(!u) return cAuthMsg.textContent='Ø§ÛŒ Ù…ÛŒÙ„ Ù†ÛÛŒÚº Ù…Ù„ÛŒ';
  const np = prompt('Ù†ÛŒØ§ Ù¾Ø§Ø³ ÙˆØ±Úˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº'); if(!np) return;
  u.pass=np; setCustomers(arr);
  cAuthMsg.textContent='Ù¾Ø§Ø³ ÙˆØ±Úˆ Ø±ÛŒ Ø³ÛŒÙ¹ ÛÙˆÚ¯ÛŒØ§ âœ…ØŒ Ø§Ø¨ Login Ú©Ø±ÛŒÚº';
}
function openCustomerArea(){
  custArea.style.display='block';
  renderReceipts();
}

/* ================== CUSTOMER RECEIPTS (SELF DATA ONLY) ================== */
function rcKey(uid){ return 'cust_'+uid+'_receipts'; }
function getMyReceipts(){
  const ses = LS.get(K.session);
  if(!ses || ses.role!=='customer') return [];
  return LS.get(rcKey(ses.id)) || [];
}
function setMyReceipts(arr){
  const ses = LS.get(K.session); if(!ses) return;
  LS.set(rcKey(ses.id), arr); renderReceipts();
}
function custUpload(){
  const ses = LS.get(K.session);
  if(!ses || ses.role!=='customer') return alert('Ù¾ÛÙ„Û’ Ù„Ø§Ú¯ Ø§ÙÙ† Ú©Ø±ÛŒÚº');
  const note = rcNote.value.trim();
  const files = Array.from(rcFile.files||[]);
  if(!files.length) return alert('ÙØ§Ø¦Ù„ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº (ØªØµÙˆÛŒØ± ÛŒØ§ PDF)');
  let arr=getMyReceipts();
  let pending=files.length, added=0;
  files.forEach(f=>{
    const rd=new FileReader();
    rd.onload=()=>{
      arr.push({id:Date.now()+Math.random(), ts:Date.now(), note, name:f.name, type:f.type, data:rd.result});
      added++; if(added===pending){ setMyReceipts(arr); rcFile.value=''; rcNote.value=''; }
    };
    if(f.type.includes('pdf')) rd.readAsDataURL(f); else rd.readAsDataURL(f);
  });
}
function renderReceipts(){
  const arr=getMyReceipts();
  const wrap = document.getElementById('rcList');
  wrap.innerHTML='';
  if(!arr.length){ wrap.innerHTML='<div class="muted">Ø§Ø¨Ú¾ÛŒ Ú©ÙˆØ¦ÛŒ ÙØ§Ø¦Ù„ Ù†ÛÛŒÚº</div>'; return;}
  arr.sort((a,b)=>b.ts-a.ts).forEach(r=>{
    const div=document.createElement('div');
    div.className='card';
    let media='';
    if((r.type||'').includes('pdf')){
      media = `<a href="${r.data}" target="_blank" class="pill">PDF Ú©Ú¾ÙˆÙ„ÛŒÚº</a>`;
    }else{
      media = `<img class="thumb" src="${r.data}" alt="file">`;
    }
    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>${r.note || r.name}</b></div>
          <div class="muted" style="font-size:12px">${new Date(r.ts).toLocaleString('ur-PK')}</div>
        </div>
        <div>${media}</div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-ghost" onclick="editReceipt(${r.id})">Ø§ÛŒÚˆÛŒÙ¹</button>
        <button class="btn btn-danger" onclick="delReceipt(${r.id})">Ø­Ø°Ù</button>
        <a class="btn btn-amber" download="${r.name||'file'}" href="${r.data}">ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ</a>
      </div>
    `;
    wrap.appendChild(div);
  });
}
function editReceipt(id){
  const arr=getMyReceipts();
  const ix=arr.findIndex(x=>x.id===id); if(ix<0) return;
  const n = prompt('Ù†ÛŒØ§ Ø¹Ù†ÙˆØ§Ù†/Ù†ÙˆÙ¹', arr[ix].note||arr[ix].name) ?? arr[ix].note;
  arr[ix].note = n;
  setMyReceipts(arr);
}
function delReceipt(id){
  if(!confirm('ÛŒÛ ÙØ§Ø¦Ù„ Ø­Ø°Ù Ú©Ø±ÛŒÚºØŸ')) return;
  let arr=getMyReceipts();
  arr = arr.filter(x=>x.id!==id);
  setMyReceipts(arr);
}

/* ================== POS: INVENTORY/SALES ================== */
function getInv(){ return LS.get(K.inv) || []; }
function setInv(arr){ LS.set(K.inv,arr); refreshInv(); }
function addItem(){
  const name=pName.value.trim(), bc=pBarcode.value.trim();
  const cost=parseFloat(pCost.value)||0, price=parseFloat(pPrice.value)||0, qty=parseInt(pQty.value)||0;
  if(!name) return alert('Ù†Ø§Ù… Ù„Ø§Ø²Ù…ÛŒ');
  const inv=getInv();
  const idx = inv.findIndex(x=>x.barcode===bc && bc);
  if(idx>-1){ inv[idx].qty += qty; inv[idx].name=name; inv[idx].cost=cost; inv[idx].price=price; }
  else inv.push({id:Date.now(),name,barcode:bc,cost,price,qty,sold:0});
  setInv(inv);
  pName.value=pBarcode.value=pCost.value=pPrice.value=pQty.value='';
}
function delItem(id){ setInv(getInv().filter(x=>x.id!==id)); }
function refreshInv(){
  const inv=getInv(); invBody.innerHTML='';
  inv.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${it.name}</td><td>${it.barcode||'-'}</td>
    <td>${fmt(it.cost)}</td><td>${fmt(it.price)}</td><td>${it.qty}</td>
    <td><button class="btn btn-danger" onclick="delItem(${it.id})">X</button></td>`;
    invBody.appendChild(tr);
  });
  document.getElementById('kpiItems').textContent = inv.length;
}

function getCart(){ return LS.get(K.cart) || []; }
function setCart(arr){ LS.set(K.cart,arr); renderCart(); }
function addToCart(){
  const q = parseInt(saleQty.value)||1;
  const key = saleSearch.value.trim();
  if(!key) return;
  const inv = getInv();
  let it = inv.find(x=>x.barcode===key) || inv.find(x=>x.name===key);
  if(!it){ alert('Ø¢Ø¦Ù¹Ù… Ù†Û Ù…Ù„Ø§'); return; }
  if(it.qty<q){ alert('Ø§Ø³Ù¹Ø§Ú© Ú©Ù… ÛÛ’'); return; }
  const cart=getCart();
  const cix = cart.findIndex(x=>x.id===it.id);
  if(cix>-1) cart[cix].qty += q;
  else cart.push({id:it.id,name:it.name,barcode:it.barcode,price:it.price,cost:it.cost,qty:q});
  setCart(cart);
  saleSearch.value=''; saleQty.value=1;
}
function removeFromCart(i){ const cart=getCart(); cart.splice(i,1); setCart(cart); }
function clearCart(){ setCart([]); updateBill(); }
function renderCart(){
  const cart=getCart(); cartBody.innerHTML='';
  cart.forEach((c,i)=>{
    const total=c.qty*c.price;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${c.name}</td><td>${c.barcode||'-'}</td>
    <td>${fmt(c.price)}</td>
    <td><input type="number" min="1" value="${c.qty}" style="width:80px" onchange="updateCartQty(${i},this.value)"></td>
    <td>${fmt(total)}</td>
    <td><button class="btn btn-danger" onclick="removeFromCart(${i})">X</button></td>`;
    cartBody.appendChild(tr);
  });
  updateBill();
}
function updateCartQty(i,val){ const cart=getCart(); cart[i].qty = parseInt(val)||1; setCart(cart); }
function updateBill(){
  const cart=getCart();
  let subtotal=0, profit=0;
  cart.forEach(c=>{ subtotal += c.qty*c.price; profit += c.qty*(c.price - (c.cost||0)); });
  const disc = parseFloat(discPct.value)||0;
  const tax = parseFloat(taxPct.value)||0;
  const afterDisc = subtotal * (1 - disc/100);
  const grand = afterDisc * (1 + tax/100);
  billTotal.textContent = fmt(grand);
  billProfit.textContent = fmt(profit * (1 - disc/100));
}
function getSales(){ return LS.get(K.sales) || []; }
function setSales(arr){ LS.set(K.sales,arr); }
function finalizeSale(){
  const cart=getCart(); if(!cart.length) return alert('Ú©Ø§Ø±Ù¹ Ø®Ø§Ù„ÛŒ');
  const inv=getInv();
  cart.forEach(c=>{
    const ix=inv.findIndex(x=>x.id===c.id);
    if(ix>-1){ inv[ix].qty -= c.qty; inv[ix].sold = (inv[ix].sold||0) + c.qty; }
  });
  setInv(inv);
  const disc = parseFloat(discPct.value)||0;
  const tax = parseFloat(taxPct.value)||0;
  const total = parseFloat(billTotal.textContent)||0;
  const profit = parseFloat(billProfit.textContent)||0;
  const sale = { id:Date.now(), ts:Date.now(), items:cart, disc, tax, total, profit };
  const sales = getSales(); sales.push(sale); setSales(sales);
  renderInvoice(sale);
  setCart([]);
  alert('Ø³ÛŒÙ„ Ù…Ø­ÙÙˆØ¸ ÛÙˆÚ¯Ø¦ÛŒ âœ…');
}
function renderInvoice(sale){
  const dt = new Date(sale.ts);
  let html = `<div><b>Invoice #${sale.id}</b> â€” ${dt.toLocaleString('ur-PK')}</div>`;
  html += `<table style="width:100%;border-collapse:collapse;margin-top:6px" border="1">
  <tr><th>Ù†Ø§Ù…</th><th>Qty</th><th>Ù‚ÛŒÙ…Øª</th><th>Ú©Ù„</th></tr>`;
  sale.items.forEach(it=>{
    html += `<tr><td>${it.name}</td><td>${it.qty}</td><td>${fmt(it.price)}</td><td>${fmt(it.qty*it.price)}</td></tr>`;
  });
  html += `</table>
  <div style="margin-top:6px">Discount: ${sale.disc}% | Tax: ${sale.tax}% | <b>Total: ${fmt(sale.total)}</b> | Profit: ${fmt(sale.profit)}</div>`;
  invoiceContent.innerHTML = html;
  invoiceArea.style.display='block';
}
function printInvoice(){
  if(invoiceArea.style.display==='none'){ return alert('Ú©ÙˆØ¦ÛŒ Ø§Ù†ÙˆØ§Ø¦Ø³ Ù†Ø¸Ø± Ù†ÛÛŒÚº Ø¢Ø±ÛÛŒ'); }
  const w=window.open('','_blank'); w.document.write('<html><body>'+invoiceContent.innerHTML+'</body></html>');
  w.document.close(); w.focus(); w.print(); w.close();
}
function shareInvoiceWA(){
  const text = invoiceContent.innerText || 'Invoice';
  window.open('https://wa.me/?text='+encodeURIComponent(text),'_blank');
}

/* ================== REPORTS ================== */
function buildReport(){
  const sales=getSales();
  const from=repFrom.value ? new Date(repFrom.value) : new Date('1970-01-01');
  const to=repTo.value ? new Date(repTo.value+'T23:59:59') : new Date();
  let sum=0, prof=0, count=0;
  const itemMap = {};
  sales.forEach(s=>{
    const d=new Date(s.ts);
    if(d>=from && d<=to){
      sum+=s.total; prof+=s.profit; count++;
      s.items.forEach(it=>{ itemMap[it.name]=(itemMap[it.name]||0)+it.qty; });
    }
  });
  repSales.textContent = fmt(sum);
  repProfit.textContent = fmt(prof);
  repBills.textContent = count;
  const hot = Object.entries(itemMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
  hotItems.innerHTML = hot.length? hot.map(([n,q])=>`<li>${n} â€” ${q}</li>`).join('') : '<li>Ú©ÙˆØ¦ÛŒ Ù†ÛÛŒÚº</li>';
  const inv=getInv();
  const dead = inv.filter(x=>(x.sold||0)===0).map(x=>x.name);
  deadItems.innerHTML = dead.length? dead.map(n=>`<li>${n}</li>`).join('') : '<li>Ú©ÙˆØ¦ÛŒ Ù†ÛÛŒÚº</li>';
}

/* ================== EXPORT/IMPORT HELPERS ================== */
function exportJSON(which){
  let data=null, name='data';
  if(which==='inventory'){ data=getInv(); name='inventory'; }
  if(which==='sales'){ data=getSales(); name='sales'; }
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name+'.json'; a.click();
}
function importJSON(ev,which){
  const f=ev.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{
    const arr=JSON.parse(rd.result||'[]');
    if(which==='inventory') setInv(arr);
    if(which==='sales') setSales(arr);
    alert('Import done');
  }; rd.readAsText(f);
}
function exportCSV(which){
  let rows=[], fname=which+'.csv';
  if(which==='inventory'){
    rows=[['name','barcode','cost','price','qty','sold'], ...getInv().map(x=>[x.name,x.barcode,x.cost,x.price,x.qty,x.sold||0])];
  } else if(which==='sales'){
    rows=[['id','ts','total','profit','items'], ...getSales().map(s=>[s.id,new Date(s.ts).toISOString(),s.total,s.profit,s.items.length])];
  }
  const csv = rows.map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download=fname; a.click();
}

/* ================== KPIs & INIT ================== */
function refreshKPIs(){
  const sales=getSales();
  const t = todayISO();
  let s=0,p=0;
  sales.forEach(x=>{
    if(new Date(x.ts).toISOString().slice(0,10)===t){ s+=x.total; p+=x.profit; }
  });
  document.getElementById('kpiSalesToday').textContent=fmt(s);
  document.getElementById('kpiProfitToday').textContent=fmt(p);
}
function refreshAdminScreens(){
  renderAdminCustomers();
  refreshInv();
}

function initAll(){
  // School
  renderTeachers();
  renderTimetable();

  // Admin session restore (show POS if already logged in)
  const ses = LS.get(K.session);
  if(ses && ses.role==='admin'){ posArea.style.display='block'; refreshAdminScreens(); }

  // Default report range = today
  const d=todayISO(); const rf=document.getElementById('repFrom'); if(rf) rf.value=d;
  const rt=document.getElementById('repTo'); if(rt) rt.value=d;

  refreshKPIs();
}
initAll();
</script>
</body>
</html>
