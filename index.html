<?php
// index.php - مکمل پورٹل + Forgot Password

// --- DB Config ---
$servername = "localhost";
$username = "root"; // اپنا db یوزر
$password = "";     // اپنا db پاسورڈ
$dbname = "school_business_portal";

$conn = new mysqli($servername,$username,$password,$dbname);
if($conn->connect_error){ die("Connection failed: ".$conn->connect_error); }

// --- Session ---
session_start();

// --- Handle Login ---
if(isset($_POST['login'])){
    $user = $_POST['username'];
    $pass = $_POST['password'];
    $stmt = $conn->prepare("SELECT * FROM users WHERE username=? LIMIT 1");
    $stmt->bind_param("s",$user);
    $stmt->execute();
    $res = $stmt->get_result();
    if($res->num_rows>0){
        $row = $res->fetch_assoc();
        if(password_verify($pass,$row['password'])){
            $_SESSION['user_id'] = $row['id'];
            $_SESSION['role'] = $row['role'];
        } else { $error="Password incorrect"; }
    } else { $error="User not found"; }
}

// --- Handle Logout ---
if(isset($_GET['logout'])){
    session_destroy();
    header("Location: index.php");
    exit;
}

// --- Handle Delete ---
if(isset($_GET['delete']) && isset($_SESSION['user_id'])){
    $id = intval($_GET['delete']);
    $conn->query("DELETE FROM business_records WHERE id=$id");
    header("Location: index.php");
    exit;
}

// --- Handle File Upload ---
if(isset($_POST['upload_file']) && isset($_SESSION['user_id'])){
    $record_id = intval($_POST['record_id']);
    $file_name = $_FILES['file']['name'];
    $file_tmp = $_FILES['file']['tmp_name'];
    $target = "uploads/".$file_name;
    if(move_uploaded_file($file_tmp,$target)){
        $stmt = $conn->prepare("INSERT INTO uploads(record_id,file_name,file_path) VALUES(?,?,?)");
        $stmt->bind_param("iss",$record_id,$file_name,$target);
        $stmt->execute();
        $success = "File uploaded successfully";
    } else { $error="Upload failed"; }
}

// --- Handle CSV Export ---
if(isset($_GET['export']) && isset($_SESSION['user_id'])){
    header('Content-Type: text/csv');
    header('Content-Disposition: attachment; filename="business_records.csv"');
    $out = fopen('php://output','w');
    fputcsv($out, ['ID','Customer','Item','Amount','Date']);
    $res = $conn->query("SELECT * FROM business_records");
    while($row = $res->fetch_assoc()){
        fputcsv($out, $row);
    }
    fclose($out);
    exit;
}

// --- Handle Add/Edit Records ---
if(isset($_POST['save_record']) && isset($_SESSION['user_id'])){
    $id = intval($_POST['record_id']);
    $customer = $_POST['customer_name'];
    $item = $_POST['item'];
    $amount = $_POST['amount'];
    if($id>0){
        $stmt = $conn->prepare("UPDATE business_records SET customer_name=?, item=?, amount=? WHERE id=?");
        $stmt->bind_param("ssdi",$customer,$item,$amount,$id);
        $stmt->execute();
    } else {
        $stmt = $conn->prepare("INSERT INTO business_records(customer_name,item,amount,date_created) VALUES(?,?,?,NOW())");
        $stmt->bind_param("ssd",$customer,$item,$amount);
        $stmt->execute();
    }
    header("Location: index.php");
    exit;
}

// --- Handle Forgot Password Request ---
if(isset($_POST['forgot_password'])){
    $email = $_POST['email'];
    $stmt = $conn->prepare("SELECT * FROM users WHERE email=? LIMIT 1");
    $stmt->bind_param("s",$email);
    $stmt->execute();
    $res = $stmt->get_result();
    if($res->num_rows>0){
        $user = $res->fetch_assoc();
        $token = bin2hex(random_bytes(50));
        $stmt2 = $conn->prepare("UPDATE users SET reset_token=?, token_expiry=DATE_ADD(NOW(), INTERVAL 30 MINUTE) WHERE id=?");
        $stmt2->bind_param("si",$token,$user['id']);
        $stmt2->execute();
        // Normally here send email with reset link
        $success = "Reset link generated. Use this token for testing: $token";
    } else { $error="Email not found"; }
}

// --- Handle Password Reset ---
if(isset($_POST['reset_password'])){
    $token = $_POST['token'];
    $new_pass = $_POST['new_password'];
    $stmt = $conn->prepare("SELECT * FROM users WHERE reset_token=? AND token_expiry>NOW() LIMIT 1");
    $stmt->bind_param("s",$token);
    $stmt->execute();
    $res = $stmt->get_result();
    if($res->num_rows>0){
        $user = $res->fetch_assoc();
        $hashed = password_hash($new_pass,PASSWORD_DEFAULT);
        $stmt2 = $conn->prepare("UPDATE users SET password=?, reset_token=NULL, token_expiry=NULL WHERE id=?");
        $stmt2->bind_param("si",$hashed,$user['id']);
        $stmt2->execute();
        $success="Password reset successfully";
    } else { $error="Invalid or expired token"; }
}

// --- Fetch Records ---
$records = [];
if(isset($_SESSION['user_id'])){
    $records_res = $conn->query("SELECT br.*, u.username FROM business_records br LEFT JOIN users u ON u.id=br.id ORDER BY br.id DESC");
    while($r = $records_res->fetch_assoc()){ $records[]=$r; }
}

// --- Fetch Uploads ---
$uploads = [];
if(isset($_GET['upload_for']) && isset($_SESSION['user_id'])){
    $rec_id = intval($_GET['upload_for']);
    $up_res = $conn->query("SELECT * FROM uploads WHERE record_id=$rec_id");
    while($u = $up_res->fetch_assoc()){ $uploads[]=$u; }
}
?>

<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>سکول + بزنس پورٹل</title>
<style>
body{font-family:sans-serif;background:#f5f5f5;padding:20px;}
table, th, td{border:1px solid #333;border-collapse:collapse;padding:5px;}
input,button{padding:5px;margin:2px;}
a{margin:0 5px;}
</style>
</head>
<body>

<?php if(!isset($_SESSION['user_id'])): ?>
<h2>Login</h2>
<form method="POST">
<input type="text" name="username" placeholder="Username" required>
<input type="password" name="password" placeholder="Password" required>
<button type="submit" name="login">Login</button>
</form>
<a href="?forgot=1">Forgot Password?</a>
<?php if(isset($error)) echo "<p style='color:red;'>$error</p>"; ?>
<?php if(isset($success)) echo "<p style='color:green;'>$success</p>"; ?>

<?php elseif(isset($_GET['forgot'])): ?>
<h2>Forgot Password</h2>
<form method="POST">
<input type="email" name="email" placeholder="Enter your email" required>
<button type="submit" name="forgot_password">Send Reset Link</button>
</form>
<?php if(isset($error)) echo "<p style='color:red;'>$error</p>"; ?>
<?php if(isset($success)) echo "<p style='color:green;'>$success</p>"; ?>

<?php elseif(isset($_GET['reset'])): ?>
<h2>Reset Password</h2>
<form method="POST">
<input type="text" name="token" placeholder="Reset Token" required>
<input type="password" name="new_password" placeholder="New Password" required>
<button type="submit" name="reset_password">Reset</button>
</form>
<?php if(isset($error)) echo "<p style='color:red;'>$error</p>"; ?>
<?php if(isset($success)) echo "<p style='color:green;'>$success</p>"; ?>

<?php else: ?>

<h2>Welcome, <?php echo $_SESSION['role']; ?></h2>
<a href="?logout=1">Logout</a> | <a href="?export=1">Export CSV</a>

<h3>Add/Edit Record</h3>
<form method="POST">
<input type="hidden" name="record_id" value="<?php echo isset($_GET['edit'])?intval($_GET['edit']):0; ?>">
<input type="text" name="customer_name" placeholder="Customer Name" required value="<?php echo isset($_GET['edit'])?$records[intval($_GET['edit'])-1]['customer_name']:''; ?>">
<input type="text" name="item" placeholder="Item" required value="<?php echo isset($_GET['edit'])?$records[intval($_GET['edit'])-1]['item']:''; ?>">
<input type="number" step="0.01" name="amount" placeholder="Amount" required value="<?php echo isset($_GET['edit'])?$records[intval($_GET['edit'])-1]['amount']:''; ?>">
<button type="submit" name="save_record">Save</button>
</form>

<h3>Business Records</h3>
<table>
<tr><th>ID</th><th>Customer</th><th>Item</th><th>Amount</th><th>Date</th><th>Actions</th></tr>
<?php foreach($records as $row): ?>
<tr>
<td><?php echo $row['id']; ?></td>
<td><?php echo $row['customer_name']; ?></td>
<td><?php echo $row['item']; ?></td>
<td><?php echo $row['amount']; ?></td>
<td><?php echo $row['date_created']; ?></td>
<td>
<a href="?edit=<?php echo $row['id']; ?>">Edit</a> | 
<a href="?delete=<?php echo $row['id']; ?>" onclick="return confirm('Are you sure?')">Delete</a> | 
<a href="?upload_for=<?php echo $row['id']; ?>">Upload/View</a>
</td>
</tr>
<?php endforeach; ?>
</table>

<?php if(isset($_GET['upload_for'])): ?>
<h3>Upload Receipt/Image for Record #<?php echo $rec_id; ?></h3>
<form method="POST" enctype="multipart/form-data">
<input type="hidden" name="record_id" value="<?php echo $rec_id; ?>">
<input type="file" name="file" required>
<button type="submit" name="upload_file">Upload</button>
</form>
<?php if(isset($success)) echo "<p style='color:green;'>$success</p>"; ?>
<?php if(isset($error)) echo "<p style='color:red;'>$error</p>"; ?>
<h4>Uploaded Files:</h4>
<ul>
<?php foreach($uploads as $u): ?>
<li><a href="<?php echo $u['file_path']; ?>" target="_blank"><?php echo $u['file_name']; ?></a></li>
<?php endforeach; ?>
</ul>
<a href="index.php">Back to Dashboard</a>
<?php endif; ?>

<?php endif; ?>
</body>
</html>
